# Example of trying to use rstanarm 

# install.packages('rstanarm')
library(tidyverse)
library(rstanarm)


mtcars <- as_tibble(mtcars, rownames = "carName")

mod_bayes <- rstanarm::stan_glm(mpg ~ cyl + disp + hp, data = mtcars, 
                                family = gaussian(link = 'identity'),
                                seed = 123)


mod_lm <- lm(mpg ~ cyl + disp + hp, data = mtcars)


# pp_check(mod_bayes)
# pp_check(mod_bayes, plotfun = "stat_2d", stat = c("mean", "sd"))


# Prediction: What's the effect of going from 2 to 8 cyl for a 160 disp vehicle with 100 hp

y_8cyl <- posterior_predict(
  mod_bayes, newdata = data.frame(disp = 160, hp = 100, cyl = 8)
)

y_2cyl <- posterior_predict(
  mod_bayes, newdata = data.frame(disp = 160, hp = 100, cyl = 2)
)


comparison <- tibble(
  pred_8cyl = y_8cyl[,1],
  pred_2cyl = y_2cyl[,1]
) |> 
  mutate(
    difference = pred_8cyl - pred_2cyl
  ) |> 
  mutate(
    n = row_number()
  ) |> 
  pivot_longer(
    -n, 
     names_to = 'scenario',
     values_to = 'estimate'
  )

comparison |> 
  ggplot(aes(x = estimate, group = scenario, fill = scenario)) +
  geom_histogram(alpha = 0.8, bins = 100) + 
  facet_wrap(~scenario) + 
  geom_vline(xintercept = 0) + 
  labs(
    title = "Posterior distributions and differences between scenarios"
  )

  
